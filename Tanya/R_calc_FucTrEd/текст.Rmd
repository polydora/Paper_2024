---
title: ""
author: ""
date: ''
output: html_document
---


```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(echo = TRUE)
```

```{r cars, include=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(broom)

library(mgcv)
library(gratia)

```


## Результаты
```{r, echo=FALSE}

myt <- read_excel('Data/FucTrEd.xlsx', sheet = 'Лист2')

myt <-
  myt %>% 
  mutate(N_total = T_a_Asc + T_a_Fuc + T_a_bot + T_dead_Asc + T_dead_Fuc + T_dead_bot + E_a_Asc + E_a_Fuc + E_a_bot + E_dead_Asc + E_dead_Fuc + E_dead_bot,
         NT = T_a_Asc + T_a_Fuc + T_a_bot + T_dead_Asc + T_dead_Fuc + T_dead_bot, 
         NE = E_a_Asc + E_a_Fuc + E_a_bot + E_dead_Asc + E_dead_Fuc + E_dead_bot,
         Prop_T = NT/(NT + NE)) %>% 
  filter(Open == 'закрытый')


myt <-
  myt %>% 
  mutate(N_Algae = T_a_Asc + T_a_Fuc + T_dead_Asc + T_dead_Fuc + E_a_Asc + E_a_Fuc + E_dead_Asc + E_dead_Fuc,
         N_Bottom = T_a_bot + T_dead_bot + E_a_bot + E_dead_bot,
         N_Algae_alive = T_a_Asc + T_a_Fuc + E_a_Asc + E_a_Fuc,
         N_Bottom_alive = T_a_bot + E_a_bot,
         B_Algae = weight_Fuc + weight_Asc)




myt <- 
myt %>% 
  mutate(Density = factor(case_when(N_total <= 20 ~ "Low",
                             N_total > 20 & N_total < 60 ~ "Medium",
                             N_total >= 60 ~ "Nigh" )))



```


### Влияние таксономической структуры на вероятность выбора в качестве субстрата фукоидов
```{r}
mod_alive <- gam(cbind(N_Algae_alive, N_Bottom_alive) ~ s(Prop_T, by = Density, k = 5) + Density  + s(B_Algae, by = Density, k = 5) , data = myt, family = "binomial", method = "REML")

kable(tidy(mod_alive, parametric = T))
kable(tidy(mod_alive, parametric = F))
#summary(mod_alive)
```

```{r}
draw(mod_alive, residuals = T, select = 1:3)
```



Из результатов анализа модели (табл. +) следует, что плотность поселения не оказывает значимого влияния на вероятность поселения мидий на фукоидах. Мы выявили значимое влияние биомассы фукоидов (Табл. +++). Однако этот фактор рассматривается нами как дополнительная ковариата, влияние которой вне интереса данного исследования.  Значимым является зависимость между вероятностью попадания на фукоиды и долей Т-морфотипа в случае средней и высокой плотности. Согласно построенной модели, вероятность поселения мидий на фукоидах увеличивается по мере роста частоты T-морфотипа (рис. +), как в случае средней, так и высокой плотности. 


## Влияние таксономической структуры на изменение величины Diff
```{r}
myt <- 
  myt %>% 
  mutate(Prop_T_Algae = (T_a_Asc + T_a_Fuc)/(T_a_Asc + T_a_Fuc + E_a_Asc + E_a_Fuc),
         Prop_T_Bottom = (T_a_bot + T_a_bot)/(T_a_bot + T_a_bot + E_a_bot + E_a_bot)
         )

myt2 <-
myt %>% 
  select(ID, Density, B_Algae, Prop_T, Prop_T_Algae, Prop_T_Bottom) %>% 
  filter(complete.cases(.)) %>% 
  rename(Algae = Prop_T_Algae, Bottom = Prop_T_Bottom) %>% 
  mutate(Diff = (Algae - Bottom) )


mod_diff <- gam(Diff ~ s(Prop_T, by = Density, bs = "cr", k = 3) + Density + s(B_Algae, by = Density), data = myt2) 

#summary(mod_diff)
kable(tidy(mod_diff, parametric = T))
kable(tidy(mod_diff, parametric = F))
```

```{r}
draw(mod_diff, residuals = T, select = 1:3)
```

Значимой связи величины Diff с плотностью выявлено не было (Табл. ++). Была отмечена статистически значимая связь с биомассой фукоидов при низкой плотности поселения. Однако, как и в случае, описанном выше, эта закономерность вне интереса данной работы. Мы выявили значимое влияние доли Т-морфотипа в садке при высокой и средней плотности поселения (Табл. +++). Согласно построенной модели, величина Diff нелинейно зависит от  доли Т-морфотипа при условии средней плотности поселения: максимум величины Diff приходится на долю T-морфотипа в диапазоне 0,1 - 0,15 (Рис. ++).  При высокой плотности наблюдается линейная связь: чем выше доля T-морфотипа в поселении тем выше величина Diff (рис. +).



## Влияние таксономической структуры на гибель мидий
```{r}

myt_status <- read_excel('Data/FucTrEd.xlsx', sheet = 'Лист3')

myt_status %>% 
  filter(Type == "ET") %>% 
  pivot_longer(cols = -c(ID, Location, Status, Morphotype, Type)  ) %>%
  uncount(value)  %>%
  as_tibble ->
  myt_outcome

myt_outcome %>%
  mutate(Out = ifelse(Status == "мертвые", 1, 0),
         Substrate = ifelse(Location == "Грунт", "Bottom", "Algae")) ->
  myt_outcome


df <- 
  myt %>% 
  select(ID, Density, Prop_T, B_Algae)

myt_outcome <- 
merge(myt_outcome, df)


# myt_outcome %>% 
#   group_by(Density, Substrate) %>% 
#   summarise(N_T = sum(Morphotype == "T"),
#             N_E = sum(Morphotype == "E")) %>% 
#   mutate(Prop_T = N_T/(N_T + N_E))


myt_substr <- 
myt_outcome %>% 
  group_by(Density, Substrate, Morphotype) %>% 
  summarise(N = n())


Mod_deadness <- gam(Out ~ s(Prop_T, by = Density ) + Density + Morphotype +  + s(B_Algae, by = Density) , family = "binomial", data = myt_outcome, method = "REML")

summary(Mod_deadness)

kable(tidy(Mod_deadness, parametric = T))
kable(tidy(Mod_deadness, parametric = F))


```

```{r}
draw(Mod_deadness, residuals = T, select = 1:3)
```

Модель выявила значимую связь между вероятностью гибели мидии и её морфотипом (табл. +). Мертвыми чаще оказывались мидии T-морфотипа.

Согласно построенной модели, вероятность гибели не имеет значимой связи  с плотностью поселения (Табл. ++). Вместе с тем, прослеживается значимая связь с морфотипом:  смертность мидий T-морфотипа выше. Кроме того, была выявлена стастически значимая связь смертности с долей Т-морфотипа при высокой плотности: в плотных поселениях вероятность гибели  снижается по мере увеличения  доли Т-морфотипа (рис. +). 

## Обсуждение результатов


Значимой связи с плотностью поселения обнаружено не было. Вероятность поселения мидий на фукоидах и Diff увеличиваются по мере возрастания доли Т-морфотипа. Такая зависимость проявляется в поселениях средней и высокой плотности. Напротив, при высокой доли Т-морфотипа происходит уменьшение смертности. 

С увеличением доли Т-морфотипа в поселении большая часть этого морфотипа оказывается на фукоидах. Этот факт может быть обьяснен тем, что мидии Т-морфотипа предпочитают этот субстрат (Katolikova et al., 2016), а так же свидетельствовать о разделении ниш. Более того, вероятность гибели Т-морфотипа на грунте выше, следовательно, в этом случае фукоиды оказываются более выгодным субстратом.

Уменьшение смертности в поселениях с высокой долей Т-морфотипа входит в противоречие с литературными данными (Шилонцев, 2023; Ковалев, 2023). Однако в этих работах влияние доли Т-морфотипа изучалось для поселений на грунте. С появлением нового субстрата появляется еще один фактор, влияющий на вероятность гибели. Мидии, оставшиеся на грунте, чаще оказываются мертвыми. Увеличение доли Т-морфотипа, в свою очередь, ведет к увеличению количества мидий на фукоидах, то есть на более благоприятном субстрате. Таким образом, смертность уменьшается. 





